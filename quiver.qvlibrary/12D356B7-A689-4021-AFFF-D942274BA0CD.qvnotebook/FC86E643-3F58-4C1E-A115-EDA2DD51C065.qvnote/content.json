{
  "title": "文件复制的4种方式",
  "cells": [
    {
      "type": "text",
      "data": "<p style=\"box-sizing: border-box; margin-bottom: 16px; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol'; font-size: 14px; font-variant-ligatures: normal; line-height: 21px; orphans: 2; widows: 2; background-color: rgb(255, 255, 255); margin-top: 0px !important;\">首先引入文件模块&nbsp;<code style=\"box-sizing: border-box; font-family: Consolas, 'Liberation Mono', Menlo, Courier, monospace; font-size: 12px;\">var fs = require('fs');</code></p><h2 style=\"box-sizing: border-box; margin-top: 24px; margin-bottom: 16px; line-height: 1.25; padding-bottom: 0.3em; border-bottom-width: 1px; border-bottom-style: solid; border-bottom-color: rgb(238, 238, 238); font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol'; font-variant-ligatures: normal; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);\">Method 1</h2><div class=\"highlight highlight-source-js\" style=\"box-sizing: border-box; margin-bottom: 16px; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol'; font-size: 14px; font-variant-ligatures: normal; line-height: 21px; orphans: 2; widows: 2; background-color: rgb(255, 255, 255); overflow: visible !important;\"><pre style=\"box-sizing: border-box; font-family: Consolas, 'Liberation Mono', Menlo, Courier, monospace; font-size: 12px; margin-top: 0px; margin-bottom: 0px; font-variant-ligatures: normal; font-variant-position: normal; font-variant-numeric: normal; font-variant-alternates: normal; font-variant-east-asian: normal; line-height: 1.45; word-wrap: normal; padding: 16px; overflow: auto; border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; word-break: normal; background-color: rgb(247, 247, 247);\"><span class=\"pl-k\" style=\"box-sizing: border-box; color: rgb(167, 29, 93);\">function</span> <span class=\"pl-en\" style=\"box-sizing: border-box; color: rgb(121, 93, 163);\">copy</span>(<span class=\"pl-smi\" style=\"box-sizing: border-box;\">src</span>, <span class=\"pl-smi\" style=\"box-sizing: border-box;\">target</span>) {\n    <span class=\"pl-en\" style=\"box-sizing: border-box; color: rgb(121, 93, 163);\">console</span>.<span class=\"pl-c1\" style=\"box-sizing: border-box; color: rgb(0, 134, 179);\">log</span>(target);\n    <span class=\"pl-smi\" style=\"box-sizing: border-box;\">fs</span>.<span class=\"pl-en\" style=\"box-sizing: border-box; color: rgb(121, 93, 163);\">writeFileSync</span>(target, <span class=\"pl-smi\" style=\"box-sizing: border-box;\">fs</span>.<span class=\"pl-en\" style=\"box-sizing: border-box; color: rgb(121, 93, 163);\">readFileSync</span>(src));\n}</pre></div><ul style=\"box-sizing: border-box; padding-left: 2em; margin-top: 0px; margin-bottom: 16px; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol'; font-size: 14px; font-variant-ligatures: normal; line-height: 21px; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);\"><li style=\"box-sizing: border-box;\">代码简短清晰</li><li style=\"box-sizing: border-box; margin-top: 0.25em;\">同步读取文件，容易阻塞</li><li style=\"box-sizing: border-box; margin-top: 0.25em;\">读取大文件时，容易内存溢出</li><li style=\"box-sizing: border-box; margin-top: 0.25em;\">尝试复制一个1.5G的电影 结果内存轻松溢出如图&nbsp;<a href=\"https://camo.githubusercontent.com/44a5d82a6f565b295ea175926644bbf21ae773d1/687474703a2f2f7069632e7975706f6f2e636f6d2f63636b696e672f4551696236484d392f346742787a2e706e67\" target=\"_blank\" style=\"box-sizing: border-box; color: rgb(64, 120, 192); text-decoration: none; background-color: transparent;\"><img src=\"quiver-image-url/73761D1FCB76A8B18C2C77276F6CC73E.png\" alt=\"\" data-canonical-src=\"http://pic.yupoo.com/ccking/EQib6HM9/4gBxz.png\" style=\"box-sizing: content-box; border-style: none;\"></a></li></ul><h2 style=\"box-sizing: border-box; margin-top: 24px; margin-bottom: 16px; line-height: 1.25; padding-bottom: 0.3em; border-bottom-width: 1px; border-bottom-style: solid; border-bottom-color: rgb(238, 238, 238); font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol'; font-variant-ligatures: normal; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);\">Method 2</h2><div class=\"highlight highlight-source-js\" style=\"box-sizing: border-box; margin-bottom: 16px; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol'; font-size: 14px; font-variant-ligatures: normal; line-height: 21px; orphans: 2; widows: 2; background-color: rgb(255, 255, 255); overflow: visible !important;\"><pre style=\"box-sizing: border-box; font-family: Consolas, 'Liberation Mono', Menlo, Courier, monospace; font-size: 12px; margin-top: 0px; margin-bottom: 0px; font-variant-ligatures: normal; font-variant-position: normal; font-variant-numeric: normal; font-variant-alternates: normal; font-variant-east-asian: normal; line-height: 1.45; word-wrap: normal; padding: 16px; overflow: auto; border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; word-break: normal; background-color: rgb(247, 247, 247);\"><span class=\"pl-k\" style=\"box-sizing: border-box; color: rgb(167, 29, 93);\">function</span> <span class=\"pl-en\" style=\"box-sizing: border-box; color: rgb(121, 93, 163);\">copy</span>(<span class=\"pl-smi\" style=\"box-sizing: border-box;\">src</span>, <span class=\"pl-smi\" style=\"box-sizing: border-box;\">target</span>) {\n    <span class=\"pl-k\" style=\"box-sizing: border-box; color: rgb(167, 29, 93);\">var</span> rs <span class=\"pl-k\" style=\"box-sizing: border-box; color: rgb(167, 29, 93);\">=</span> <span class=\"pl-smi\" style=\"box-sizing: border-box;\">fs</span>.<span class=\"pl-en\" style=\"box-sizing: border-box; color: rgb(121, 93, 163);\">createReadStream</span>(src),\n        ws <span class=\"pl-k\" style=\"box-sizing: border-box; color: rgb(167, 29, 93);\">=</span> <span class=\"pl-smi\" style=\"box-sizing: border-box;\">fs</span>.<span class=\"pl-en\" style=\"box-sizing: border-box; color: rgb(121, 93, 163);\">createWriteStream</span>(target);\n\n    <span class=\"pl-smi\" style=\"box-sizing: border-box;\">fs</span>.<span class=\"pl-en\" style=\"box-sizing: border-box; color: rgb(121, 93, 163);\">on</span>(<span class=\"pl-s\" style=\"box-sizing: border-box; color: rgb(24, 54, 145);\"><span class=\"pl-pds\" style=\"box-sizing: border-box;\">'</span>data<span class=\"pl-pds\" style=\"box-sizing: border-box;\">'</span></span>, <span class=\"pl-k\" style=\"box-sizing: border-box; color: rgb(167, 29, 93);\">function</span>(<span class=\"pl-smi\" style=\"box-sizing: border-box;\">chunk</span>) {\n        <span class=\"pl-en\" style=\"box-sizing: border-box; color: rgb(121, 93, 163);\">console</span>.<span class=\"pl-c1\" style=\"box-sizing: border-box; color: rgb(0, 134, 179);\">log</span>(<span class=\"pl-s\" style=\"box-sizing: border-box; color: rgb(24, 54, 145);\"><span class=\"pl-pds\" style=\"box-sizing: border-box;\">'</span>read<span class=\"pl-pds\" style=\"box-sizing: border-box;\">'</span></span>);\n        <span class=\"pl-smi\" style=\"box-sizing: border-box;\">ws</span>.<span class=\"pl-c1\" style=\"box-sizing: border-box; color: rgb(0, 134, 179);\">write</span>(chunk, <span class=\"pl-k\" style=\"box-sizing: border-box; color: rgb(167, 29, 93);\">function</span>() {\n            <span class=\"pl-en\" style=\"box-sizing: border-box; color: rgb(121, 93, 163);\">console</span>.<span class=\"pl-c1\" style=\"box-sizing: border-box; color: rgb(0, 134, 179);\">log</span>(<span class=\"pl-s\" style=\"box-sizing: border-box; color: rgb(24, 54, 145);\"><span class=\"pl-pds\" style=\"box-sizing: border-box;\">'</span>write<span class=\"pl-pds\" style=\"box-sizing: border-box;\">'</span></span>);\n        })\n    })\n\n    <span class=\"pl-smi\" style=\"box-sizing: border-box;\">fs</span>.<span class=\"pl-en\" style=\"box-sizing: border-box; color: rgb(121, 93, 163);\">on</span>(<span class=\"pl-s\" style=\"box-sizing: border-box; color: rgb(24, 54, 145);\"><span class=\"pl-pds\" style=\"box-sizing: border-box;\">'</span>end<span class=\"pl-pds\" style=\"box-sizing: border-box;\">'</span></span>, <span class=\"pl-k\" style=\"box-sizing: border-box; color: rgb(167, 29, 93);\">function</span>() {\n        <span class=\"pl-smi\" style=\"box-sizing: border-box;\">ws</span>.<span class=\"pl-en\" style=\"box-sizing: border-box; color: rgb(121, 93, 163);\">end</span>();\n    })\n}</pre></div><ul style=\"box-sizing: border-box; padding-left: 2em; margin-top: 0px; margin-bottom: 16px; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol'; font-size: 14px; font-variant-ligatures: normal; line-height: 21px; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);\"><li style=\"box-sizing: border-box;\">读取大文件时不太容易导致内存溢出</li><li style=\"box-sizing: border-box; margin-top: 0.25em;\">代码比较复杂</li><li style=\"box-sizing: border-box; margin-top: 0.25em;\">由于读取和写入的速度不一样，同样存在内存溢出的风险，不过比 Method 1 好很多</li></ul><h2 style=\"box-sizing: border-box; margin-top: 24px; margin-bottom: 16px; line-height: 1.25; padding-bottom: 0.3em; border-bottom-width: 1px; border-bottom-style: solid; border-bottom-color: rgb(238, 238, 238); font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol'; font-variant-ligatures: normal; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);\">Method 3</h2><p style=\"box-sizing: border-box; margin-top: 0px; margin-bottom: 16px; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol'; font-size: 14px; font-variant-ligatures: normal; line-height: 21px; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);\">根据 Method 2 改进</p><div class=\"highlight highlight-source-js\" style=\"box-sizing: border-box; margin-bottom: 16px; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol'; font-size: 14px; font-variant-ligatures: normal; line-height: 21px; orphans: 2; widows: 2; background-color: rgb(255, 255, 255); overflow: visible !important;\"><pre style=\"box-sizing: border-box; font-family: Consolas, 'Liberation Mono', Menlo, Courier, monospace; font-size: 12px; margin-top: 0px; margin-bottom: 0px; font-variant-ligatures: normal; font-variant-position: normal; font-variant-numeric: normal; font-variant-alternates: normal; font-variant-east-asian: normal; line-height: 1.45; word-wrap: normal; padding: 16px; overflow: auto; border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; word-break: normal; background-color: rgb(247, 247, 247);\"><span class=\"pl-k\" style=\"box-sizing: border-box; color: rgb(167, 29, 93);\">function</span> <span class=\"pl-en\" style=\"box-sizing: border-box; color: rgb(121, 93, 163);\">copy</span>(<span class=\"pl-smi\" style=\"box-sizing: border-box;\">src</span>, <span class=\"pl-smi\" style=\"box-sizing: border-box;\">target</span>) {\n    <span class=\"pl-k\" style=\"box-sizing: border-box; color: rgb(167, 29, 93);\">var</span> rs <span class=\"pl-k\" style=\"box-sizing: border-box; color: rgb(167, 29, 93);\">=</span> <span class=\"pl-smi\" style=\"box-sizing: border-box;\">fs</span>.<span class=\"pl-en\" style=\"box-sizing: border-box; color: rgb(121, 93, 163);\">createReadStream</span>(src),\n        ws <span class=\"pl-k\" style=\"box-sizing: border-box; color: rgb(167, 29, 93);\">=</span> <span class=\"pl-smi\" style=\"box-sizing: border-box;\">fs</span>.<span class=\"pl-en\" style=\"box-sizing: border-box; color: rgb(121, 93, 163);\">createWriteStream</span>(target);\n\n    <span class=\"pl-smi\" style=\"box-sizing: border-box;\">fs</span>.<span class=\"pl-en\" style=\"box-sizing: border-box; color: rgb(121, 93, 163);\">on</span>(<span class=\"pl-s\" style=\"box-sizing: border-box; color: rgb(24, 54, 145);\"><span class=\"pl-pds\" style=\"box-sizing: border-box;\">'</span>data<span class=\"pl-pds\" style=\"box-sizing: border-box;\">'</span></span>, <span class=\"pl-k\" style=\"box-sizing: border-box; color: rgb(167, 29, 93);\">function</span>(<span class=\"pl-smi\" style=\"box-sizing: border-box;\">chunk</span>) {\n        <span class=\"pl-en\" style=\"box-sizing: border-box; color: rgb(121, 93, 163);\">console</span>.<span class=\"pl-c1\" style=\"box-sizing: border-box; color: rgb(0, 134, 179);\">log</span>(<span class=\"pl-s\" style=\"box-sizing: border-box; color: rgb(24, 54, 145);\"><span class=\"pl-pds\" style=\"box-sizing: border-box;\">'</span>read<span class=\"pl-pds\" style=\"box-sizing: border-box;\">'</span></span>);\n        <span class=\"pl-k\" style=\"box-sizing: border-box; color: rgb(167, 29, 93);\">if</span> (<span class=\"pl-smi\" style=\"box-sizing: border-box;\">ws</span>.<span class=\"pl-c1\" style=\"box-sizing: border-box; color: rgb(0, 134, 179);\">write</span>(chunk, <span class=\"pl-k\" style=\"box-sizing: border-box; color: rgb(167, 29, 93);\">function</span>() {\n                <span class=\"pl-en\" style=\"box-sizing: border-box; color: rgb(121, 93, 163);\">console</span>.<span class=\"pl-c1\" style=\"box-sizing: border-box; color: rgb(0, 134, 179);\">log</span>(<span class=\"pl-s\" style=\"box-sizing: border-box; color: rgb(24, 54, 145);\"><span class=\"pl-pds\" style=\"box-sizing: border-box;\">'</span>write<span class=\"pl-pds\" style=\"box-sizing: border-box;\">'</span></span>);\n            }) <span class=\"pl-k\" style=\"box-sizing: border-box; color: rgb(167, 29, 93);\">===</span> <span class=\"pl-c1\" style=\"box-sizing: border-box; color: rgb(0, 134, 179);\">false</span>) {\n            <span class=\"pl-smi\" style=\"box-sizing: border-box;\">rs</span>.<span class=\"pl-en\" style=\"box-sizing: border-box; color: rgb(121, 93, 163);\">pause</span>();\n        } <span class=\"pl-k\" style=\"box-sizing: border-box; color: rgb(167, 29, 93);\">else</span> {\n            <span class=\"pl-smi\" style=\"box-sizing: border-box;\">rs</span>.<span class=\"pl-en\" style=\"box-sizing: border-box; color: rgb(121, 93, 163);\">resume</span>();\n        }\n    })\n\n    <span class=\"pl-smi\" style=\"box-sizing: border-box;\">fs</span>.<span class=\"pl-en\" style=\"box-sizing: border-box; color: rgb(121, 93, 163);\">on</span>(<span class=\"pl-s\" style=\"box-sizing: border-box; color: rgb(24, 54, 145);\"><span class=\"pl-pds\" style=\"box-sizing: border-box;\">'</span>end<span class=\"pl-pds\" style=\"box-sizing: border-box;\">'</span></span>, <span class=\"pl-k\" style=\"box-sizing: border-box; color: rgb(167, 29, 93);\">function</span>() {\n        <span class=\"pl-smi\" style=\"box-sizing: border-box;\">ws</span>.<span class=\"pl-en\" style=\"box-sizing: border-box; color: rgb(121, 93, 163);\">end</span>();\n    })\n}</pre></div><ul style=\"box-sizing: border-box; padding-left: 2em; margin-top: 0px; margin-bottom: 16px; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol'; font-size: 14px; font-variant-ligatures: normal; line-height: 21px; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);\"><li style=\"box-sizing: border-box;\">同步了读取和写入的速度，没有内存溢出的风险</li><li style=\"box-sizing: border-box; margin-top: 0.25em;\">代码比较复杂</li></ul><h2 style=\"box-sizing: border-box; margin-top: 24px; margin-bottom: 16px; line-height: 1.25; padding-bottom: 0.3em; border-bottom-width: 1px; border-bottom-style: solid; border-bottom-color: rgb(238, 238, 238); font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol'; font-variant-ligatures: normal; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);\">Method 4</h2><p style=\"box-sizing: border-box; margin-top: 0px; margin-bottom: 16px; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol'; font-size: 14px; font-variant-ligatures: normal; line-height: 21px; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);\">node中支持pipe方法，类似于管道，将读出来的内容通过管道写入到目标文件中</p><div class=\"highlight highlight-source-js\" style=\"box-sizing: border-box; margin-bottom: 16px; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol'; font-size: 14px; font-variant-ligatures: normal; line-height: 21px; orphans: 2; widows: 2; background-color: rgb(255, 255, 255); overflow: visible !important;\"><pre style=\"box-sizing: border-box; font-family: Consolas, 'Liberation Mono', Menlo, Courier, monospace; font-size: 12px; margin-top: 0px; margin-bottom: 0px; font-variant-ligatures: normal; font-variant-position: normal; font-variant-numeric: normal; font-variant-alternates: normal; font-variant-east-asian: normal; line-height: 1.45; word-wrap: normal; padding: 16px; overflow: auto; border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; word-break: normal; background-color: rgb(247, 247, 247);\"><span class=\"pl-k\" style=\"box-sizing: border-box; color: rgb(167, 29, 93);\">function</span> <span class=\"pl-en\" style=\"box-sizing: border-box; color: rgb(121, 93, 163);\">copy</span>(<span class=\"pl-smi\" style=\"box-sizing: border-box;\">src</span>, <span class=\"pl-smi\" style=\"box-sizing: border-box;\">target</span>) {\n    <span class=\"pl-smi\" style=\"box-sizing: border-box;\">fs</span>.<span class=\"pl-en\" style=\"box-sizing: border-box; color: rgb(121, 93, 163);\">createReadStream</span>(src).<span class=\"pl-en\" style=\"box-sizing: border-box; color: rgb(121, 93, 163);\">pipe</span>(<span class=\"pl-smi\" style=\"box-sizing: border-box;\">fs</span>.<span class=\"pl-en\" style=\"box-sizing: border-box; color: rgb(121, 93, 163);\">createWriteStream</span>(target));\n}</pre></div><ul style=\"box-sizing: border-box; padding-left: 2em; margin-top: 0px; margin-bottom: 16px; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol'; font-size: 14px; font-variant-ligatures: normal; line-height: 21px; orphans: 2; widows: 2; background-color: rgb(255, 255, 255);\"><li style=\"box-sizing: border-box;\">代码简洁</li><li style=\"box-sizing: border-box; margin-top: 0.25em;\">没有内存溢出的风险</li></ul><p style=\"box-sizing: border-box; margin-top: 0px; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol'; font-size: 14px; font-variant-ligatures: normal; line-height: 21px; orphans: 2; widows: 2; background-color: rgb(255, 255, 255); margin-bottom: 0px !important;\">1.64G 的文件用了20秒复制完毕，没有内存溢出</p>"
    }
  ]
}