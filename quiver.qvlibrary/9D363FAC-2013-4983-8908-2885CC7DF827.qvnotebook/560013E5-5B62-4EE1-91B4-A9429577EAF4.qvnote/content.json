{
  "title": "arpwatch 查看网络地址转换过程",
  "cells": [
    {
      "type": "text",
      "data": "<h2 style=\"margin: 0px; padding: 0px; font-family: Arial; line-height: 26px; widows: 1; background-color: rgb(255, 255, 255);\"><a id=\"一.arp协议简介\" name=\"一.arp协议简介\" style=\"color: rgb(51, 102, 153);\">一.ARP协议简介</a></h2><div class=\"level2\" style=\"font-family: Arial; font-size: 14px; line-height: 26px; widows: 1; background-color: rgb(255, 255, 255);\"><p>当主机上的需要发送一个数据到一个目的IP时,设备驱动程序并不能理解这个IP地址.<br>系统需要将IP地址转换为网络地址,再传递给设备驱动程序发送出去.<br>ARP(地址解析协议)就是这样的一种网络协议.用于将高层协议地址(IP地址)转换为物理<br>网络地址.<br><span class=\"search_hit\">linux</span>内核中保存有一个ARP表,里面保存有IP地址和MAC地址的对应关系.使用arp命令<br>可以查看主机的ARP表.<br></p><pre class=\"code\" name=\"code\" style=\"white-space: pre-wrap; word-wrap: break-word;\"># arp -a<br>m1 (192.168.0.1) at 00:E0:4C:FF:D7:31 [ether] on eth0<br></pre></div><h2 style=\"margin: 0px; padding: 0px; font-family: Arial; line-height: 26px; widows: 1; background-color: rgb(255, 255, 255);\"><a name=\"t1\" style=\"color: rgb(51, 102, 153);\"></a><a id=\"二.arp协议相关工具\" name=\"二.arp协议相关工具\" style=\"color: rgb(51, 102, 153);\">二.ARP协议相关工具</a></h2><div class=\"level2\" style=\"font-family: Arial; font-size: 14px; line-height: 26px; widows: 1; background-color: rgb(255, 255, 255);\"></div><h3 style=\"margin: 0px; padding: 0px; font-family: Arial; line-height: 26px; widows: 1; background-color: rgb(255, 255, 255);\"><a name=\"t2\" style=\"color: rgb(51, 102, 153);\"></a><a id=\"arptables\" name=\"arptables\" style=\"color: rgb(51, 102, 153);\">1.<span class=\"search_hit\">arptables</span></a></h3><div class=\"level3\" style=\"font-family: Arial; font-size: 14px; line-height: 26px; widows: 1; background-color: rgb(255, 255, 255);\"></div><h4 style=\"margin: 0px; padding: 0px; font-family: Arial; font-size: 14px; line-height: 26px; widows: 1; background-color: rgb(255, 255, 255);\"><a name=\"t3\" style=\"color: rgb(51, 102, 153);\"></a><a id=\"a_arptables简介\" name=\"a_arptables简介\" style=\"color: rgb(51, 102, 153);\">a)<span class=\"search_hit\">arptables</span>简介</a></h4><div class=\"level4\" style=\"font-family: Arial; font-size: 14px; line-height: 26px; widows: 1; background-color: rgb(255, 255, 255);\"><p><span class=\"search_hit\">arptables</span>是用户空间工具,用来管理&nbsp;<span class=\"search_hit\">linux</span>内核中的ARP规则表.这些规则用来<br>检查ARP帧.<span class=\"search_hit\">arptables</span>类似于iptables,但没有那么复杂.iptables工作于ip层,<br>用于对ip包进行管理.<span class=\"search_hit\">arptables</span>工作与arp协议层,用于对arp数据帧进行管理.<br><span class=\"search_hit\">arptables</span>可以像iptables那样对arp数据帧进行各种规则设置,可以ACCEPT,<br>DROP等.<br></p></div><h4 style=\"margin: 0px; padding: 0px; font-family: Arial; font-size: 14px; line-height: 26px; widows: 1; background-color: rgb(255, 255, 255);\"><a name=\"t4\" style=\"color: rgb(51, 102, 153);\"></a><a id=\"b_arptables的安装\" name=\"b_arptables的安装\" style=\"color: rgb(51, 102, 153);\">b)<span class=\"search_hit\">arptables</span>的安装</a></h4><div class=\"level4\" style=\"font-family: Arial; font-size: 14px; line-height: 26px; widows: 1; background-color: rgb(255, 255, 255);\"><p>Turbo<span class=\"search_hit\">linux</span>&nbsp;10.5和11版本中,已经集成有<span class=\"search_hit\">arptables</span>命令.<br>你也可以从源码进行安装:<br></p><pre class=\"code\" name=\"code\" style=\"white-space: pre-wrap; word-wrap: break-word;\"># wget -c http://jaist.dl.sourceforge.net/sourceforge/ebtables/<span class=\"search_hit\">arptables</span>-v0.0.3-3.tar.gz<br># tar zxvf <span class=\"search_hit\">arptables</span>-v0.0.3-3.tar.gz<br># cd <span class=\"search_hit\">arptables</span>-v0.0.3-3<br># make<br># make install<br></pre></div><h4 style=\"margin: 0px; padding: 0px; font-family: Arial; font-size: 14px; line-height: 26px; widows: 1; background-color: rgb(255, 255, 255);\"><a name=\"t5\" style=\"color: rgb(51, 102, 153);\"></a><a id=\"c_arptables命令的语法\" name=\"c_arptables命令的语法\" style=\"color: rgb(51, 102, 153);\">c)<span class=\"search_hit\">arptables</span>命令的语法</a></h4><div class=\"level4\" style=\"font-family: Arial; font-size: 14px; line-height: 26px; widows: 1; background-color: rgb(255, 255, 255);\"><pre class=\"code\" name=\"code\" style=\"white-space: pre-wrap; word-wrap: break-word;\">       <span class=\"search_hit\">arptables</span> [-t table] -[AD] chain rule-specification [options]<br>       <span class=\"search_hit\">arptables</span> [-t table] -[RI] chain rulenum rule-specification [options]<br>       <span class=\"search_hit\">arptables</span> [-t table] -D chain rulenum [options]<br>       <span class=\"search_hit\">arptables</span> [-t table] -[LFZ] [chain] [options]<br>       <span class=\"search_hit\">arptables</span> [-t table] -[NX] chain<br>       <span class=\"search_hit\">arptables</span> [-t table] -E old-chain-name new-chain-name<br>       <span class=\"search_hit\">arptables</span> [-t table] -P chain target [options]<br></pre><p>链(chain)<br>kernel表是用来区分不同设置的不同功能.规则的每个设置叫做一个”链”.每个链<br>是有一个排序了的规则列表,用来于ARP帧相匹配.如果一个规则与一个ARP帧<br>相匹配,一个”操作说明”会提供需要进行哪些操作.操作说明叫做”目标”.然而,<br>如果帧与当前链中的当前规则不匹配,则继续与链中的下一条规则进行检查.用<br>户可以建立一个新的链,作为规则的”目标”来使用.<br><br>目标(target)<br>包含有一个ARP帧与一个帧处理说明的防火墙规则说明叫做一个”目标”.当一个<br>帧与一个规则相匹配时,则kernel按”目标”的定义进行下一步操作.“目标”可以是:<br>ACCEPT,DROP.CONTINUE,RETURN,扩展定义或用户指定规则.<br>ACCEPT表示允许这个帧通过.DROP表示这个帧将被丢弃.CONTINUE表示继续<br>进行下一条规则.这样可以很方便的计算,有多少帧经过了某个规则.RETURN表示<br>不在这个链中继续进行匹配,返回到上一条链的下一条规则.<br><br>表(table)<br>在kernel中只有一个ARP表.这个表是一个过滤器.你可以在<span class=\"search_hit\">arptables</span>命令中使用<br>’-t filter’参数.使用时,-t参数必须是<span class=\"search_hit\">arptables</span>命令的第一个参数.<br>-t,–table<br>是一个过滤器,在kernel中仅有这一个表,它包含2个(2.4.x内核)或3个(2.6.x内核)内建规则:<br>INPUT(发送帧的源主机),OUTPUT(本地产生的帧),FORWARD(由桥代码转发的帧).<br>2.4.X内核中没有FORWARD规则.<br><br><span class=\"search_hit\">arptables</span>命令参数<br>命令行参数分为几个部分:命令部分,杂项部分,规则说明,匹配扩展,监视器扩展.<br><br>命令(command)<br><span class=\"search_hit\">arptables</span>命令参数用于指定在使用-t参数定义的表中的执行动作.如果你没有使用<br>-t参数指定一个表名,则命令将应用于默认的过滤表.使用-Z命令时,命令行每次只能<br>使用一个命令.<br>-A,–append<br>在指定的链结尾添加一个规则.<br>-D,–delete<br>从指定的链中删除规则.这个命令有2种用法:<br>1.指定要删除规则的序号,语法是: start_nr[:end_nr],可以使用负数.<br>2.指定要删除规则的详细内容.<br>-I,–insert<br>按序号,在指定的链中插入规则.如当前的序号为N,则可以使用-N到N+1<br>作为插入序号.序号0表示表示在最后一条规则后插入新规则,等同于-A参数.<br>-R,–replace<br>替换链中指定的规则.如果当前的序号是N,则指定的序号可以是1到N之间的<br>数字.<br>-P,–policy<br>在链中设置指定目标的策略,可以为:ACCEPT,DROP或RETURN.<br>-F,–flush<br>清空指定的链.如果没有指定链,则所有的链都将被清空.清空链不会改变链的<br>策略.<br>-Z,–zero<br>将指定链的计数器置0.如果没有指定链,则所有计数器都将置0.-Z命令可以与<br>-L命令结合使用.当同时使用-Z,-L命令时,计数器的值会先被打印出来,然后置0.<br>-L,–list<br>输出指定链中的规则.如果没有指定链,所有将输出所有链中的规则.<br>-N,–new-chain<br>建立新的用户链.用户链的数量没有限制,但用户链的名称最多可以有31个字符.<br>-X,–delete-chain<br>删除指定的用户链.用户链中必须为空.如果没有指定用户链,则所有为空的用户链<br>将被删除.<br>-E,–rename-chain<br>重命名指定链.你可以重命名一个用户链,也可以重命名一个标准链名.<br><br>&lt;其他命令&gt;<br>-V,–version<br>显示<span class=\"search_hit\">arptables</span>程序的版本号.<br>-h,–help<br>输出语法帮助信息.<br>-j,–jump 目标<br>规则的目标.可以是:ACCEPT,DROP,CONTINUE,RETURN,目标扩展或用户<br>定义链名.<br><br>&lt;规则说明&gt;<br>-s,–source-ip [!] IP地址[/掩码]<br>源IP地址<br><br>-d,–destination-ip [!] IP地址[/掩码]<br>目的IP地址<br><br>–source-mac [!] MAC地址[/掩码]<br>源MAC地址<br><br>–destination-mac [!] MAC地址[/掩码]<br>目的MAC地址.<br><br>-i,–in-interface [!] 设备名<br>用于接收帧的接口(应用于INPUT,FORWARD链).–in-if是这个选项的别名.<br><br>-o,–out-interface [!] 设备名<br>用于发送帧的接口(应用于OUTPUT,FORWARD链).–out-if是这个选项的别名.<br><br>-l,–h-length 长度[/掩码]<br>硬件长度(单位字节).<br><br>–opcode 代码[/掩码]<br>操作码(2字节).可以使用:1=请求,2=回复,3=反解析请求,4=反解析回复,<br>5=动态反解析请求,6=动态反解析回复,7=动态反解析错误,8=逆向ARP请求,<br>9=ARP_NAK<br><br>–h-type 类型[/掩码]<br>硬件类型(2字节,十六进制).可以使用:1=Ethernet.<br><br>–proto-type 类型[/mask]<br>协议类型(2字节).可以使用:0×800=IPv4<br><br></p></div><h4 style=\"margin: 0px; padding: 0px; font-family: Arial; font-size: 14px; line-height: 26px; widows: 1; background-color: rgb(255, 255, 255);\"><a name=\"t6\" style=\"color: rgb(51, 102, 153);\"></a><a id=\"d_arptables使用实例\" name=\"d_arptables使用实例\" style=\"color: rgb(51, 102, 153);\">d)<span class=\"search_hit\">arptables</span>使用实例</a></h4><div class=\"level4\" style=\"font-family: Arial; font-size: 14px; line-height: 26px; widows: 1; background-color: rgb(255, 255, 255);\"><pre class=\"code\" name=\"code\" style=\"white-space: pre-wrap; word-wrap: break-word;\"># arp -a<br>m1 (192.168.0.1) at 00:E0:4C:FF:D7:31 [ether] on eth0<br>显示当前ARP表信息<br>当前ARP表中保存有一个主机的arp信息,m1主机,ip地址192.168.0.1<br><br># <span class=\"search_hit\">arptables</span>  -D INPUT -s 192.168.0.1 -j DROP<br>设置arp规则,将所有192.168.0.1的arp包全部丢弃.<br><br># arp -d 192.168.0.1 -i eth0<br>使用arp命令,删除arp表中的192.168.0.1的记录.<br><br># arp -a<br>m1 (192.168.0.1) at &lt;incomplete&gt; on eth0<br>arp表中已没有m1主机的信息.<br><br># ping 192.168.0.1<br>PING m1 (192.168.0.1) 56(84) bytes of data.<br>From m2 (192.168.0.2) icmp_seq=2 Destination Host Unreachable<br>From m2 (192.168.0.2) icmp_seq=3 Destination Host Unreachable<br>From m2 (192.168.0.2) icmp_seq=4 Destination Host Unreachable<br>由于无法获得m1主机MAC信息,所以,无法与m1主机进行通信.<br><br># <span class=\"search_hit\">arptables</span>  -D INPUT -s 192.168.0.1 -j DROP<br>删除<span class=\"search_hit\">arptables</span>规则.<br><br># arp -a<br>m1 (192.168.0.1) at 00:E0:4C:FF:D7:31 [ether] on eth0<br>arp表中重新记录了m1的MAC信息.<br><br># ping 192.168.0.1<br>PING m1 (192.168.0.1) 56(84) bytes of data.<br>64 bytes from m1 (192.168.0.1): icmp_seq=1 ttl=64 time=0.315 ms<br><br></pre></div><h3 style=\"margin: 0px; padding: 0px; font-family: Arial; line-height: 26px; widows: 1; background-color: rgb(255, 255, 255);\"><a name=\"t7\" style=\"color: rgb(51, 102, 153);\"></a><a id=\"arpwatch\" name=\"arpwatch\" style=\"color: rgb(51, 102, 153);\">2.arpwatch</a></h3><div class=\"level3\" style=\"font-family: Arial; font-size: 14px; line-height: 26px; widows: 1; background-color: rgb(255, 255, 255);\"></div><h4 style=\"margin: 0px; padding: 0px; font-family: Arial; font-size: 14px; line-height: 26px; widows: 1; background-color: rgb(255, 255, 255);\"><a name=\"t8\" style=\"color: rgb(51, 102, 153);\"></a><a id=\"a_arpwatch简介\" name=\"a_arpwatch简介\" style=\"color: rgb(51, 102, 153);\">a)arpwatch简介</a></h4><div class=\"level4\" style=\"font-family: Arial; font-size: 14px; line-height: 26px; widows: 1; background-color: rgb(255, 255, 255);\"><p>arpwatch用来监听网络中的ARP数据包并进行记录,同时将监听到的<br>变化通过E-mail来报告给系统管理员.<br>arpwatch使用pcap(3)来监听本地以太接口的arp数据包.<br><br></p></div><h4 style=\"margin: 0px; padding: 0px; font-family: Arial; font-size: 14px; line-height: 26px; widows: 1; background-color: rgb(255, 255, 255);\"><a name=\"t9\" style=\"color: rgb(51, 102, 153);\"></a><a id=\"b_arpwatch的安装\" name=\"b_arpwatch的安装\" style=\"color: rgb(51, 102, 153);\">b)arpwatch的安装</a></h4><div class=\"level4\" style=\"font-family: Arial; font-size: 14px; line-height: 26px; widows: 1; background-color: rgb(255, 255, 255);\"><p>Turbo<span class=\"search_hit\">linux</span>&nbsp;10.5和11版本中,已经集成有arpwatch.<br>你也可以从源码安装:<br></p><pre class=\"code\" name=\"code\" style=\"white-space: pre-wrap; word-wrap: break-word;\"># wget -c ftp://ftp.ee.lbl.gov/arpwatch.tar.gz<br># cd arpwatch-2.1a15<br># ./configure<br># make<br># make install<br></pre></div><h4 style=\"margin: 0px; padding: 0px; font-family: Arial; font-size: 14px; line-height: 26px; widows: 1; background-color: rgb(255, 255, 255);\"><a name=\"t10\" style=\"color: rgb(51, 102, 153);\"></a><a id=\"c_arpwath命令的语法\" name=\"c_arpwath命令的语法\" style=\"color: rgb(51, 102, 153);\">c)arpwath命令的语法</a></h4><div class=\"level4\" style=\"font-family: Arial; font-size: 14px; line-height: 26px; widows: 1; background-color: rgb(255, 255, 255);\"><pre class=\"code\" name=\"code\" style=\"white-space: pre-wrap; word-wrap: break-word;\">       arpwatch [ -dN ]<br>               [ -f datafile ]<br>               [ -i interface ]<br>               [ -n net[/width ]]<br>               [ -r file ]<br>               [ -s sendmail_path ]<br>               [ -p ]<br>               [ -a ]<br>               [ -m addr ]<br>               [ -u username ]<br>               [ -R seconds ]<br>               [ -Q ]<br>               [ -z ignorenet/ignoremask ]<br></pre><p>-d 标记用来启用调试模式.<br>-f 标记用来设置使用的数据库名,默认是arp.dat.<br>-i 用来指定网络接口.<br>-n 用于说明本地网络.<br>-r 指定读取一个由tcpdump或pcapture生成信息文件,而不从网络接口中<br></p><pre class=\"code\" name=\"code\" style=\"white-space: pre-wrap; word-wrap: break-word;\"> 读取.//</pre><p>-s 用于指定sendmail程序的路径.<br>-p 指定禁用”混合模式”.网络接口不是”混合模式”时,ARP广播也可以通过.<br>-a 默认情况下,arpwatch仅记录默认网络接口上,第一个IP地址子网的arp<br>信息.使用-a参数,则记录网络接口上所有IP地址子网的arp信息.<br>-m 指定一个用于接收变更信息的邮件地址.<br><br></p></div><h4 style=\"margin: 0px; padding: 0px; font-family: Arial; font-size: 14px; line-height: 26px; widows: 1; background-color: rgb(255, 255, 255);\"><a name=\"t11\" style=\"color: rgb(51, 102, 153);\"></a><a id=\"d_arpwatch使用实例\" name=\"d_arpwatch使用实例\" style=\"color: rgb(51, 102, 153);\">d)arpwatch使用实例</a></h4><div class=\"level4\" style=\"font-family: Arial; font-size: 14px; line-height: 26px; widows: 1; background-color: rgb(255, 255, 255);\"><pre class=\"code\" name=\"code\" style=\"white-space: pre-wrap; word-wrap: break-word;\"># arpwatch -i eth0 -s root@localhost.localdomain<br>监听eth0接口,并将arp的变更信息,发送到本地的root用户邮箱中.</pre></div>"
    }
  ]
}